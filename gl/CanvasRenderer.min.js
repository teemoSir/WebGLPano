/**
 * @author mrdoob / http://mrdoob.com/
 */
THREE.SpriteCanvasMaterial=function(v){THREE.Material.call(this);this.type="SpriteCanvasMaterial";this.color=new THREE.Color(16777215);this.program=function(){};this.setValues(v)};THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial;THREE.SpriteCanvasMaterial.prototype.isSpriteCanvasMaterial=!0;THREE.SpriteCanvasMaterial.prototype.clone=function(){var v=new THREE.SpriteCanvasMaterial;v.copy(this);v.color.copy(this.color);v.program=this.program;return v};THREE.CanvasRenderer=function(v){function aa(d,e,h,g){I!==e&&(I=a.lineWidth=e);J!==h&&(J=a.lineCap=h);K!==g&&(K=a.lineJoin=g);L(d.getStyle());a.stroke();C.expandByScalar(2*e)}function ba(d){D(d.getStyle());a.fill()}function na(d){if(0===d.version||d instanceof THREE.CompressedTexture||d instanceof THREE.DataTexture)return{canvas:void 0,version:d.version};var e=d.image;if(!1===e.complete)return{canvas:void 0,version:0};var h=d.wrapS===THREE.RepeatWrapping||d.wrapS===THREE.MirroredRepeatWrapping,g=d.wrapT===THREE.RepeatWrapping||d.wrapT===THREE.MirroredRepeatWrapping,b=d.wrapS===THREE.MirroredRepeatWrapping,f=d.wrapT===THREE.MirroredRepeatWrapping,c=document.createElement("canvas");c.width=e.width*(b?2:1);c.height=e.height*(f?2:1);var m=c.getContext("2d");m.setTransform(1,0,0,-1,0,e.height);m.drawImage(e,0,0);!0===b&&(m.setTransform(-1,0,0,-1,e.width,e.height),m.drawImage(e,-e.width,0));!0===f&&(m.setTransform(1,0,0,1,0,0),m.drawImage(e,0,e.height));!0===b&&!0===f&&(m.setTransform(-1,0,0,1,e.width,0),m.drawImage(e,-e.width,e.height));e="no-repeat";!0===h&&!0===g?e="repeat":!0===h?e="repeat-x":!0===g&&(e="repeat-y");h=a.createPattern(c,e);if(d.onUpdate)d.onUpdate(d);return{canvas:h,version:d.version}}function oa(d,e,g,n,b,f,c,m,k,p,q,r,l){var h=T[l.id];if(void 0===h||h.version!==l.version)h=na(l),T[l.id]=h;if(void 0!==h.canvas){D(h.canvas);var h=l.offset.x/l.repeat.x,t=l.offset.y/l.repeat.y,u=l.image.width*l.repeat.x;l=l.image.height*l.repeat.y;c=(c+h)*u;m=(m+t)*l;g-=d;n-=e;b-=d;f-=e;k=(k+h)*u-c;p=(p+t)*l-m;q=(q+h)*u-c;r=(r+t)*l-m;l=k*r-q*p;0!==l&&(h=1/l,l=(r*g-p*b)*h,p=(r*n-p*f)*h,g=(k*b-q*g)*h,n=(k*f-q*n)*h,d=d-l*c-g*m,e=e-p*c-n*m,a.save(),a.transform(l,p,g,n,d,e),a.fill(),a.restore())}else D("rgba( 0, 0, 0, 1)"),a.fill()}function ca(a,e,h){var d=e.x-a.x,b=e.y-a.y,f=d*d+b*b;0!==f&&(h/=Math.sqrt(f),d*=h,b*=h,e.x+=d,e.y+=b,a.x-=d,a.y-=b)}function M(d){da!==d&&(da=a.globalAlpha=d)}function N(d){ea!==d&&(d===THREE.NormalBlending?a.globalCompositeOperation="source-over":d===THREE.AdditiveBlending?a.globalCompositeOperation="lighter":d===THREE.SubtractiveBlending?a.globalCompositeOperation="darker":d===THREE.MultiplyBlending&&(a.globalCompositeOperation="multiply"),ea=d)}function L(d){fa!==d&&(fa=a.strokeStyle=d)}function D(d){ga!==d&&(ga=a.fillStyle=d)}function pa(d){qa.length!==d.length&&(a.setLineDash(d),qa=d)}console.log("THREE.CanvasRenderer",THREE.REVISION);v=v||{};var O=this,ha,ia,P,Fa=new THREE.Projector,A=void 0!==v.canvas?v.canvas:document.createElement("canvas"),F=A.width,E=A.height,u=Math.floor(F/2),w=Math.floor(E/2),ra=0,sa=0,ta=F,ua=E,x=1,a=A.getContext("2d",{alpha:!0===v.alpha}),G=new THREE.Color(0),Q=!0===v.alpha?0:1,da=1,ea=0,fa=null,ga=null,I=null,J=null,K=null,qa=[],n,t,B,U,V,W,X,Y,Z,y=new THREE.Color,ja=new THREE.Color,va=new THREE.Color,ka=new THREE.Color,T={},H,wa,xa,ya,za,Aa,Ba,R=new THREE.Box2,g=new THREE.Box2,C=new THREE.Box2,la=new THREE.Color,Ca=new THREE.Color,Da=new THREE.Color,ma=new THREE.Vector3,Ea=new THREE.Vector3,z=new THREE.Vector3,S=new THREE.Matrix3;void 0===a.setLineDash&&(a.setLineDash=function(){});this.domElement=A;this.sortElements=this.sortObjects=this.autoClear=!0;this.info={render:{vertices:0,faces:0}};this.getContext=function(){return a};this.getContextAttributes=function(){return a.getContextAttributes()};this.getPixelRatio=function(){return x};this.setPixelRatio=function(a){void 0!==a&&(x=a)};this.setSize=function(a,e,h){F=a*x;E=e*x;A.width=F;A.height=E;u=Math.floor(F/2);w=Math.floor(E/2);!1!==h&&(A.style.width=a+"px",A.style.height=e+"px");R.min.set(-u,-w);R.max.set(u,w);g.min.set(-u,-w);g.max.set(u,w);da=1;ea=0;K=J=I=ga=fa=null;this.setViewport(0,0,a,e)};this.setViewport=function(a,e,h,g){ra=a*x;sa=e*x;ta=h*x;ua=g*x};this.setScissor=function(){};this.setScissorTest=function(){};this.setClearColor=function(a,e){G.set(a);Q=void 0!==e?e:1;g.min.set(-u,-w);g.max.set(u,w)};this.setClearColorHex=function(a,e){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(a,e)};this.getClearColor=function(){return G};this.getClearAlpha=function(){return Q};this.getMaxAnisotropy=function(){return 0};this.clear=function(){!1===g.isEmpty()&&(g.intersect(R),g.expandByScalar(2),g.min.x+=u,g.min.y=-g.min.y+w,g.max.x+=u,g.max.y=-g.max.y+w,1>Q&&a.clearRect(g.min.x|0,g.max.y|0,g.max.x-g.min.x|0,g.min.y-g.max.y|0),0<Q&&(M(1),N(THREE.NormalBlending),D("rgba("+Math.floor(255*G.r)+","+Math.floor(255*G.g)+","+Math.floor(255*G.b)+","+Q+")"),a.fillRect(g.min.x|0,g.max.y|0,g.max.x-g.min.x|0,g.min.y-g.max.y|0)),g.makeEmpty())};this.clearColor=function(){};this.clearDepth=function(){};this.clearStencil=function(){};this.render=function(d,e){if(void 0===e.isCamera)console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");else{var h=d.background;h&&h.isColor?(M(1),N(THREE.NormalBlending),D(h.getStyle()),a.fillRect(0,0,F,E)):!0===this.autoClear&&this.clear();O.info.render.vertices=0;O.info.render.faces=0;a.setTransform(ta/F,0,0,-ua/E,ra,E-sa);a.translate(u,w);ha=Fa.projectScene(d,e,this.sortObjects,this.sortElements);ia=ha.elements;P=ha.lights;S.getNormalMatrix(e.matrixWorldInverse);la.setRGB(0,0,0);Ca.setRGB(0,0,0);Da.setRGB(0,0,0);for(var h=0,v=P.length;h<v;h++){var b=P[h],f=b.color;b.isAmbientLight?la.add(f):b.isDirectionalLight?Ca.add(f):b.isPointLight&&Da.add(f)}h=0;for(v=ia.length;h<v;h++){var c=ia[h],m=c.material;if(void 0!==m&&0!==m.opacity){C.makeEmpty();if(c instanceof THREE.RenderableSprite){n=c;n.x*=u;n.y*=w;var b=n,k=c,f=m;M(f.opacity);N(f.blending);var p=k.scale.x*u,k=k.scale.y*w,c=Math.sqrt(p*p+k*k);C.min.set(b.x-c,b.y-c);C.max.set(b.x+c,b.y+c);if(f.isSpriteMaterial){var q=f.map;if(null!==q){c=T[q.id];if(void 0===c||c.version!==q.version)c=na(q),T[q.id]=c;if(void 0!==c.canvas){D(c.canvas);var r=q.image,c=r.width*q.offset.x,m=r.height*q.offset.y,l=r.width*q.repeat.x,q=r.height*q.repeat.y,r=p/l,A=k/q;a.save();a.translate(b.x,b.y);0!==f.rotation&&a.rotate(f.rotation);a.translate(-p/2,-k/2);a.scale(r,A);a.translate(-c,-m);a.fillRect(c,m,l,q);a.restore()}}else D(f.color.getStyle()),a.save(),a.translate(b.x,b.y),0!==f.rotation&&a.rotate(f.rotation),a.scale(p,-k),a.fillRect(-.5,-.5,1,1),a.restore()}else f.isSpriteCanvasMaterial?(L(f.color.getStyle()),D(f.color.getStyle()),a.save(),a.translate(b.x,b.y),0!==f.rotation&&a.rotate(f.rotation),a.scale(p,k),f.program(a),a.restore()):f.isPointsMaterial&&(D(f.color.getStyle()),a.save(),a.translate(b.x,b.y),0!==f.rotation&&a.rotate(f.rotation),a.scale(p*f.size,-k*f.size),a.fillRect(-.5,-.5,1,1),a.restore())}else if(c instanceof THREE.RenderableLine){if(n=c.v1,t=c.v2,n.positionScreen.x*=u,n.positionScreen.y*=w,t.positionScreen.x*=u,t.positionScreen.y*=w,C.setFromPoints([n.positionScreen,t.positionScreen]),!0===R.intersectsBox(C)&&(b=n,f=t,p=c,k=m,M(k.opacity),N(k.blending),a.beginPath(),a.moveTo(b.positionScreen.x,b.positionScreen.y),a.lineTo(f.positionScreen.x,f.positionScreen.y),k.isLineBasicMaterial)){c=k.linewidth;I!==c&&(I=a.lineWidth=c);c=k.linecap;J!==c&&(J=a.lineCap=c);c=k.linejoin;K!==c&&(K=a.lineJoin=c);if(k.vertexColors!==THREE.VertexColors)L(k.color.getStyle());else if(c=p.vertexColors[0].getStyle(),p=p.vertexColors[1].getStyle(),c===p)L(c);else{try{var x=a.createLinearGradient(b.positionScreen.x,b.positionScreen.y,f.positionScreen.x,f.positionScreen.y);x.addColorStop(0,c);x.addColorStop(1,p)}catch(Ga){x=c}L(x)}k.isLineDashedMaterial&&pa([k.dashSize,k.gapSize]);a.stroke();C.expandByScalar(2*k.linewidth);k.isLineDashedMaterial&&pa([])}}else if(c instanceof THREE.RenderableFace){n=c.v1;t=c.v2;B=c.v3;if(-1>n.positionScreen.z||1<n.positionScreen.z)continue;if(-1>t.positionScreen.z||1<t.positionScreen.z)continue;if(-1>B.positionScreen.z||1<B.positionScreen.z)continue;n.positionScreen.x*=u;n.positionScreen.y*=w;t.positionScreen.x*=u;t.positionScreen.y*=w;B.positionScreen.x*=u;B.positionScreen.y*=w;0<m.overdraw&&(ca(n.positionScreen,t.positionScreen,m.overdraw),ca(t.positionScreen,B.positionScreen,m.overdraw),ca(B.positionScreen,n.positionScreen,m.overdraw));C.setFromPoints([n.positionScreen,t.positionScreen,B.positionScreen]);if(!0===R.intersectsBox(C)){f=n;p=t;k=B;b=m;O.info.render.vertices+=3;O.info.render.faces++;M(b.opacity);N(b.blending);U=f.positionScreen.x;V=f.positionScreen.y;W=p.positionScreen.x;X=p.positionScreen.y;Y=k.positionScreen.x;Z=k.positionScreen.y;var m=U,l=V,q=W,r=X,A=Y,G=Z;a.beginPath();a.moveTo(m,l);a.lineTo(q,r);a.lineTo(A,G);a.closePath();if((b.isMeshLambertMaterial||b.isMeshPhongMaterial||b.isMeshStandardMaterial)&&null===b.map){ja.copy(b.color);va.copy(b.emissive);b.vertexColors===THREE.FaceColors&&ja.multiply(c.color);y.copy(la);Ea.copy(f.positionWorld).add(p.positionWorld).add(k.positionWorld).divideScalar(3);f=Ea;p=c.normalModel;k=y;c=0;for(m=P.length;c<m;c++)l=P[c],ka.copy(l.color),l.isDirectionalLight?(q=ma.setFromMatrixPosition(l.matrixWorld).normalize(),r=p.dot(q),0>=r||(r*=l.intensity,k.add(ka.multiplyScalar(r)))):l.isPointLight&&(q=ma.setFromMatrixPosition(l.matrixWorld),r=p.dot(ma.subVectors(q,f).normalize()),0>=r||(r*=0==l.distance?1:1-Math.min(f.distanceTo(q)/l.distance,1),0!=r&&(r*=l.intensity,k.add(ka.multiplyScalar(r)))));y.multiply(ja).add(va);!0===b.wireframe?aa(y,b.wireframeLinewidth,b.wireframeLinecap,b.wireframeLinejoin):ba(y)}else b.isMeshBasicMaterial||b.isMeshLambertMaterial||b.isMeshPhongMaterial||b.isMeshStandardMaterial?null!==b.map?b.map.mapping===THREE.UVMapping&&(H=c.uvs,oa(U,V,W,X,Y,Z,H[0].x,H[0].y,H[1].x,H[1].y,H[2].x,H[2].y,b.map)):null!==b.envMap?b.envMap.mapping===THREE.SphericalReflectionMapping&&(z.copy(c.vertexNormalsModel[0]).applyMatrix3(S),wa=.5*z.x+.5,xa=.5*z.y+.5,z.copy(c.vertexNormalsModel[1]).applyMatrix3(S),ya=.5*z.x+.5,za=.5*z.y+.5,z.copy(c.vertexNormalsModel[2]).applyMatrix3(S),Aa=.5*z.x+.5,Ba=.5*z.y+.5,oa(U,V,W,X,Y,Z,wa,xa,ya,za,Aa,Ba,b.envMap)):(y.copy(b.color),b.vertexColors===THREE.FaceColors&&y.multiply(c.color),!0===b.wireframe?aa(y,b.wireframeLinewidth,b.wireframeLinecap,b.wireframeLinejoin):ba(y)):(b.isMeshNormalMaterial?(z.copy(c.normalModel).applyMatrix3(S),y.setRGB(z.x,z.y,z.z).multiplyScalar(.5).addScalar(.5)):y.setRGB(1,1,1),!0===b.wireframe?aa(y,b.wireframeLinewidth,b.wireframeLinecap,b.wireframeLinejoin):ba(y))}}g.union(C)}}a.setTransform(1,0,0,1,0,0)}}};