/**
* attempt of a simple defer/promise library for mobile development
* @author Jonathan Gotti < jgotti at jgotti dot net>
* @since 2012-10
* @version 0.7.5
*/
(function(h){function y(a){n(function(){throw a;})}function z(a){return this.then(a,h)}function t(a){return this.then(h,a)}function u(a,c){return this.then(function(c){return k(a)?a.apply(null,m(c)?c:[c]):b.onlyFuncs?c:a},c||h)}function A(a){function c(){a()}this.then(c,c);return this}function B(a){return this.then(function(c){return k(a)?a.apply(null,m(c)?c.splice(0,0,void 0)&&c:[void 0,c]):b.onlyFuncs?c:a},function(c){return a(c)})}function C(a){return this.then(h,a?function(c){a(c);throw c;}:y)}function v(a,c){var d=[].slice.call(a,void 0);if(1===d.length&&m(d[0])){if(!d[0].length)return b.fulfilled([]);d=d[0]}var e=[],f=b(),g=d.length;if(g)for(var k=function(a){d[a]=b.promisify(d[a]);d[a].then(function(b){e[a]=c?d[a]:b;--g||f.resolve(e)},function(b){c?(e[a]=d[a],--g||f.resolve(e)):f.reject(b)})},l=0,h=g;l<h;l++)k(l);else f.resolve(e);return f.promise}function E(a,b){return a.then(k(b)?b:function(){return b})}var n,k=function(a){return"function"===typeof a},m=function(a){return Array.isArray?Array.isArray(a):a instanceof Array},F="undefined"===typeof TypeError?Error:TypeError;if("undefined"!==typeof process&&process.nextTick)n=process.nextTick;else if("undefined"!==typeof MessageChannel){var x=new MessageChannel,r=[];x.port1.onmessage=function(){r.length&&r.shift()()};n=function(a){r.push(a);x.port2.postMessage(0)}}else n=function(a){setTimeout(a,0)};var b=function(a){function c(){if(0!==g){var a=m,b=0,c=a.length,d=~g?0:1,f;for(m=[];b<c;b++)(f=a[b][d])&&f(l)}}function d(a){function b(a){return function(b){if(!h)return h=!0,a(b)}}var h=!1;if(g)return this;try{var w=!(!a||!(typeof a).match(/function|object/))&&a.then;if(k(w)){if(a===p)throw new F("Promise can't resolve itself");w.call(a,b(d),b(e));return this}}catch(q){return b(e)(q),this}f(function(){l=a;g=1;c()});return this}function e(a){g||f(function(){try{throw a;}catch(D){l=D}g=-1;c()});return this}var f=(h!==a?a:b.alwaysAsync)?n:function(a){a()},g=0,m=[],l,p={then:function(a,d){var e=b();m.push([function(c){try{!1===a||a===h||null===a?e.resolve(c):e.resolve(k(a)?a(c):b.onlyFuncs?c:a)}catch(q){e.reject(q)}},function(a){(!1===d||d===h||null===d||!k(d)&&b.onlyFuncs)&&e.reject(a);if(d)try{e.resolve(k(d)?d(a):d)}catch(q){e.reject(q)}}]);0!==g&&f(c);return e.promise},success:z,error:t,otherwise:t,apply:u,spread:u,ensure:A,nodify:B,rethrow:C,isPending:function(){return 0===g},getStatus:function(){return g}};p.toSource=p.toString=p.valueOf=function(){return l===h?this:l};return{promise:p,resolve:d,fulfill:d,reject:e}};b.deferred=b.defer=b;b.nextTick=n;b.alwaysAsync=!0;b.onlyFuncs=!0;b.resolve=b.resolved=b.fulfilled=function(a){return b(!0).resolve(a).promise};b.reject=b.rejected=function(a){return b(!0).reject(a).promise};b.wait=function(a){var c=b();setTimeout(c.resolve,a||0);return c.promise};b.delay=function(a,c){var d=b();setTimeout(function(){try{d.resolve(k(a)?a.apply(null):a)}catch(e){d.reject(e)}},c||0);return d.promise};b.promisify=function(a){return a&&k(a.then)?a:b.resolved(a)};b.all=function(){return v(arguments,!1)};b.resolveAll=function(){return v(arguments,!0)};b.sequence=function(){var a=[].slice.call(arguments,void 0);1===a.length&&m(a[0])&&(a=a[0]);for(var c=b(),d=0,e=a.length,f=b.resolved();d<e;d++)f=E(f,a[d]);c.resolve(f);return c.promise};b.nodeCapsule=function(a,c){c||(c=a,a=void 0);return function(){var d=b(),e=[].slice.call(arguments,void 0);e.push(function(a,b){a?d.reject(a):d.resolve(2<arguments.length?[].slice.call(arguments,1):b)});try{c.apply(a,e)}catch(f){d.reject(f)}return d.promise}};if("function"===typeof define&&define.amd)define("D.js",[],function(){return b});else if("undefined"!==typeof module&&module.exports)module.exports=b;else if("undefined"!==typeof window){var G=window.D;b.noConflict=function(){window.D=G;return b};window.D=b}})();