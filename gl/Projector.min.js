/**
 * @author mrdoob / http://mrdoob.com/
 * @author supereggbert / http://www.paulbrunt.co.uk/
 * @author julianwa / https://github.com/julianwa
 */
THREE.RenderableObject=function(){this.id=0;this.object=null;this.renderOrder=this.z=0};THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.normalModel=new THREE.Vector3;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsLength=0;this.color=new THREE.Color;this.material=null;this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2];this.renderOrder=this.z=0};THREE.RenderableVertex=function(){this.position=new THREE.Vector3;this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=!0};THREE.RenderableVertex.prototype.copy=function(N){this.positionWorld.copy(N.positionWorld);this.positionScreen.copy(N.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null;this.renderOrder=this.z=0};THREE.RenderableSprite=function(){this.id=0;this.object=null;this.rotation=this.z=this.y=this.x=0;this.scale=new THREE.Vector2;this.material=null;this.renderOrder=0};THREE.Projector=function(){function N(a){if(!1!==a.visible){if(a instanceof THREE.Light)w.lights.push(a);else if(a instanceof THREE.Mesh||a instanceof THREE.Line||a instanceof THREE.Points){if(!1===a.material.visible||!0===a.frustumCulled&&!1===T.intersectsObject(a))return;X(a)}else if(a instanceof THREE.Sprite){if(!1===a.material.visible||!0===a.frustumCulled&&!1===T.intersectsSprite(a))return;X(a)}a=a.children;for(var h=0,d=a.length;h<d;h++)N(a[h])}}function X(a){if(P===Y){var h=new THREE.RenderableObject;Z.push(h);Y++;P++;E=h}else E=Z[P++];E.id=a.id;E.object=a;v.setFromMatrixPosition(a.matrixWorld);v.applyMatrix4(I);E.z=v.z;E.renderOrder=a.renderOrder;w.objects.push(E)}function U(a,h,d){var l=1/a.w;a.z*=l;if(-1<=a.z&&1>=a.z){if(Q===aa){var t=new THREE.RenderableSprite;ba.push(t);aa++;Q++;p=t}else p=ba[Q++];p.id=h.id;p.x=a.x*l;p.y=a.y*l;p.z=a.z;p.renderOrder=h.renderOrder;p.object=h;p.rotation=h.rotation;p.scale.x=h.scale.x*Math.abs(p.x-(a.x+d.projectionMatrix.elements[0])/(a.w+d.projectionMatrix.elements[12]));p.scale.y=h.scale.y*Math.abs(p.y-(a.y+d.projectionMatrix.elements[5])/(a.w+d.projectionMatrix.elements[13]));p.material=h.material;w.elements.push(p)}}function V(){if(O===ca){var a=new THREE.RenderableVertex;z.push(a);ca++;O++;return a}return z[O++]}function da(){if(R===ea){var a=new THREE.RenderableFace;fa.push(a);ea++;R++;return a}return fa[R++]}function ga(){if(S===ha){var a=new THREE.RenderableLine;ia.push(a);ha++;S++;return a}return ia[S++]}function ja(a,h){return a.renderOrder!==h.renderOrder?a.renderOrder-h.renderOrder:a.z!==h.z?h.z-a.z:a.id!==h.id?a.id-h.id:0}function ka(a,h){var d=0,l=1,t=a.z+a.w,f=h.z+h.w,c=-a.z+a.w,n=-h.z+h.w;if(0<=t&&0<=f&&0<=c&&0<=n)return!0;if(0>t&&0>f||0>c&&0>n)return!1;0>t?d=Math.max(d,t/(t-f)):0>f&&(l=Math.min(l,t/(t-f)));0>c?d=Math.max(d,c/(c-n)):0>n&&(l=Math.min(l,c/(c-n)));if(l<d)return!1;a.lerp(h,d);h.lerp(a,1-l);return!0}var E,P,Z=[],Y=0,J,O,z=[],ca=0,d,R,fa=[],ea=0,l,S,ia=[],ha=0,p,Q,ba=[],aa=0,w={objects:[],lights:[],elements:[]},v=new THREE.Vector3,A=new THREE.Vector4,ma=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),na=new THREE.Box3,F=Array(3),la=new THREE.Matrix4,I=new THREE.Matrix4,G,H=new THREE.Matrix4,W=new THREE.Matrix3,T=new THREE.Frustum,L=new THREE.Vector4,M=new THREE.Vector4;this.projectVector=function(a,d){console.warn("THREE.Projector: .projectVector() is now vector.project().");a.project(d)};this.unprojectVector=function(a,d){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");a.unproject(d)};this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var q=new function(){function a(a){var c=a.positionWorld,d=a.positionScreen;c.copy(a.position).applyMatrix4(G);d.copy(c).applyMatrix4(I);c=1/d.w;d.x*=c;d.y*=c;d.z*=c;a.visible=-1<=d.x&&1>=d.x&&-1<=d.y&&1>=d.y&&-1<=d.z&&1>=d.z}function h(a,c,d){if(!0===a.visible||!0===c.visible||!0===d.visible)return!0;F[0]=a.positionScreen;F[1]=c.positionScreen;F[2]=d.positionScreen;return ma.intersectsBox(na.setFromPoints(F))}function q(a,c,d){return 0>(d.positionScreen.x-a.positionScreen.x)*(c.positionScreen.y-a.positionScreen.y)-(d.positionScreen.y-a.positionScreen.y)*(c.positionScreen.x-a.positionScreen.x)}var p=[],t=[],f=[],c=null,n=new THREE.Matrix3;return{setObject:function(a){c=a;n.getNormalMatrix(c.matrixWorld);p.length=0;t.length=0;f.length=0},projectVertex:a,checkTriangleVisibility:h,checkBackfaceCulling:q,pushVertex:function(c,d,f){J=V();J.position.set(c,d,f);a(J)},pushNormal:function(a,c,d){p.push(a,c,d)},pushColor:function(a,c,d){t.push(a,c,d)},pushUv:function(a,c){f.push(a,c)},pushLine:function(a,d){var f=z[a],g=z[d];f.positionScreen.copy(f.position).applyMatrix4(H);g.positionScreen.copy(g.position).applyMatrix4(H);!0===ka(f.positionScreen,g.positionScreen)&&(f.positionScreen.multiplyScalar(1/f.positionScreen.w),g.positionScreen.multiplyScalar(1/g.positionScreen.w),l=ga(),l.id=c.id,l.v1.copy(f),l.v2.copy(g),l.z=Math.max(f.positionScreen.z,g.positionScreen.z),l.renderOrder=c.renderOrder,l.material=c.material,c.material.vertexColors===THREE.VertexColors&&(l.vertexColors[0].fromArray(t,3*a),l.vertexColors[1].fromArray(t,3*d)),w.elements.push(l))},pushTriangle:function(a,l,D,g){var b=z[a],e=z[l],m=z[D];if(!1!==h(b,e,m)&&(g.side===THREE.DoubleSide||!0===q(b,e,m))){d=da();d.id=c.id;d.v1.copy(b);d.v2.copy(e);d.v3.copy(m);d.z=(b.positionScreen.z+e.positionScreen.z+m.positionScreen.z)/3;d.renderOrder=c.renderOrder;v.subVectors(m.position,e.position);A.subVectors(b.position,e.position);v.cross(A);d.normalModel.copy(v);d.normalModel.applyMatrix3(n).normalize();for(b=0;3>b;b++)e=d.vertexNormalsModel[b],e.fromArray(p,3*arguments[b]),e.applyMatrix3(n).normalize(),d.uvs[b].fromArray(f,2*arguments[b]);d.vertexNormalsLength=3;d.material=g;g.vertexColors!==THREE.FaceColors&&g.vertexColors!==THREE.VertexColors||d.color.fromArray(t,3*a);w.elements.push(d)}}}};this.projectScene=function(a,h,p,E){Q=S=R=0;w.elements.length=0;!0===a.autoUpdate&&a.updateMatrixWorld();null===h.parent&&h.updateMatrixWorld();la.copy(h.matrixWorldInverse);I.multiplyMatrices(h.projectionMatrix,la);T.setFromMatrix(I);P=0;w.objects.length=0;w.lights.length=0;N(a);!0===p&&w.objects.sort(ja);a=w.objects;p=0;for(var t=a.length;p<t;p++){var f=a[p].object,c=f.geometry;q.setObject(f);G=f.matrixWorld;O=0;if(f instanceof THREE.Mesh)if(c instanceof THREE.BufferGeometry){var n=f.material,F=Array.isArray(n),m=c.attributes,D=c.groups;if(void 0!==m.position){for(var g=m.position.array,b=0,e=g.length;b<e;b+=3){var x=g[b],K=g[b+1],J=g[b+2];if(!0===n.morphTargets)for(var k=c.morphAttributes.position,u=f.morphTargetInfluences,B=0,C=k.length;B<C;B++){var y=u[B];if(0!==y)var r=k[B],x=x+(r.getX(b/3)-g[b])*y,K=K+(r.getY(b/3)-g[b+1])*y,J=J+(r.getZ(b/3)-g[b+2])*y}q.pushVertex(x,K,J)}if(void 0!==m.normal)for(k=m.normal.array,b=0,e=k.length;b<e;b+=3)q.pushNormal(k[b],k[b+1],k[b+2]);if(void 0!==m.color)for(k=m.color.array,b=0,e=k.length;b<e;b+=3)q.pushColor(k[b],k[b+1],k[b+2]);if(void 0!==m.uv)for(k=m.uv.array,b=0,e=k.length;b<e;b+=2)q.pushUv(k[b],k[b+1]);if(null!==c.index)if(c=c.index.array,0<D.length)for(k=0;k<D.length;k++){if(u=D[k],n=!0===F?f.material[u.materialIndex]:f.material,void 0!==n)for(b=u.start,e=u.start+u.count;b<e;b+=3)q.pushTriangle(c[b],c[b+1],c[b+2],n)}else for(b=0,e=c.length;b<e;b+=3)q.pushTriangle(c[b],c[b+1],c[b+2],n);else if(0<D.length)for(k=0;k<D.length;k++){if(u=D[k],n=!0===F?f.material[u.materialIndex]:f.material,void 0!==n)for(b=u.start,e=u.start+u.count;b<e;b+=3)q.pushTriangle(b,b+1,b+2,n)}else for(b=0,e=g.length/3;b<e;b+=3)q.pushTriangle(b,b+1,b+2,n)}}else{if(c instanceof THREE.Geometry){e=c.vertices;b=c.faces;D=c.faceVertexUvs[0];W.getNormalMatrix(G);n=f.material;F=Array.isArray(n);g=0;for(m=e.length;g<m;g++){x=e[g];v.copy(x);if(!0===n.morphTargets)for(k=c.morphTargets,u=f.morphTargetInfluences,B=0,C=k.length;B<C;B++)y=u[B],0!==y&&(r=k[B],r=r.vertices[g],v.x+=(r.x-x.x)*y,v.y+=(r.y-x.y)*y,v.z+=(r.z-x.z)*y);q.pushVertex(v.x,v.y,v.z)}u=0;for(B=b.length;u<B;u++)if(C=b[u],n=!0===F?f.material[C.materialIndex]:f.material,void 0!==n&&(e=n.side,c=z[C.a],k=z[C.b],y=z[C.c],!1!==q.checkTriangleVisibility(c,k,y))){r=q.checkBackfaceCulling(c,k,y);if(e!==THREE.DoubleSide){if(e===THREE.FrontSide&&!1===r)continue;if(e===THREE.BackSide&&!0===r)continue}d=da();d.id=f.id;d.v1.copy(c);d.v2.copy(k);d.v3.copy(y);d.normalModel.copy(C.normal);!1!==r||e!==THREE.BackSide&&e!==THREE.DoubleSide||d.normalModel.negate();d.normalModel.applyMatrix3(W).normalize();g=C.vertexNormals;m=0;for(x=Math.min(g.length,3);m<x;m++)K=d.vertexNormalsModel[m],K.copy(g[m]),!1!==r||e!==THREE.BackSide&&e!==THREE.DoubleSide||K.negate(),K.applyMatrix3(W).normalize();d.vertexNormalsLength=g.length;e=D[u];if(void 0!==e)for(r=0;3>r;r++)d.uvs[r].copy(e[r]);d.color=C.color;d.material=n;d.z=(c.positionScreen.z+k.positionScreen.z+y.positionScreen.z)/3;d.renderOrder=f.renderOrder;w.elements.push(d)}}}else if(f instanceof THREE.Line)if(H.multiplyMatrices(I,G),c instanceof THREE.BufferGeometry){if(m=c.attributes,void 0!==m.position){g=m.position.array;b=0;for(e=g.length;b<e;b+=3)q.pushVertex(g[b],g[b+1],g[b+2]);if(void 0!==m.color)for(k=m.color.array,b=0,e=k.length;b<e;b+=3)q.pushColor(k[b],k[b+1],k[b+2]);if(null!==c.index)for(c=c.index.array,b=0,e=c.length;b<e;b+=2)q.pushLine(c[b],c[b+1]);else for(n=f instanceof THREE.LineSegments?2:1,b=0,e=g.length/3-1;b<e;b+=n)q.pushLine(b,b+1)}}else{if(c instanceof THREE.Geometry&&(e=f.geometry.vertices,0!==e.length))for(c=V(),c.positionScreen.copy(e[0]).applyMatrix4(H),n=f instanceof THREE.LineSegments?2:1,g=1,m=e.length;g<m;g++)c=V(),c.positionScreen.copy(e[g]).applyMatrix4(H),0<(g+1)%n||(k=z[O-2],L.copy(c.positionScreen),M.copy(k.positionScreen),!0===ka(L,M)&&(L.multiplyScalar(1/L.w),M.multiplyScalar(1/M.w),l=ga(),l.id=f.id,l.v1.positionScreen.copy(L),l.v2.positionScreen.copy(M),l.z=Math.max(L.z,M.z),l.renderOrder=f.renderOrder,l.material=f.material,f.material.vertexColors===THREE.VertexColors&&(l.vertexColors[0].copy(f.geometry.colors[g]),l.vertexColors[1].copy(f.geometry.colors[g-1])),w.elements.push(l)))}else if(f instanceof THREE.Points)if(H.multiplyMatrices(I,G),c instanceof THREE.Geometry)for(e=f.geometry.vertices,g=0,m=e.length;g<m;g++)x=e[g],A.set(x.x,x.y,x.z,1),A.applyMatrix4(H),U(A,f,h);else{if(c instanceof THREE.BufferGeometry&&(m=c.attributes,void 0!==m.position))for(g=m.position.array,b=0,e=g.length;b<e;b+=3)A.set(g[b],g[b+1],g[b+2],1),A.applyMatrix4(H),U(A,f,h)}else f instanceof THREE.Sprite&&(f.modelViewMatrix.multiplyMatrices(h.matrixWorldInverse,f.matrixWorld),A.set(G.elements[12],G.elements[13],G.elements[14],1),A.applyMatrix4(I),U(A,f,h))}!0===E&&w.elements.sort(ja);return w}};